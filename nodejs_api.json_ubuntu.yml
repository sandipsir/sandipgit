---
- hosts: all
  gather_facts: yes
  become: yes
  vars:
    NODEJS_VERSION: "8"
    ansible_distribution_release: "xenial" #trusty
  tasks:
    - name: Install the gpg key for nodejs LTS
      apt_key:
        url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
        state: present

    - name: Install the nodejs LTS repos
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ NODEJS_VERSION }}.x {{ ansible_distribution_release }} main"
        state: present
        update_cache: yes

    - name: Install the nodejs
      apt:
        name: nodejs
        state: present

    - name: Install the nginx
      apt:
        name: nginx
        state: present

    - name: start nginx
      service:
          name: nginx
          state: started

    - name: install NPM
      apt:
        name: npm
        state: latest

    - name: Install PM2
      command: chdir=/root/ npm install pm2 -g

    - name: creat file index.js
      file:
        path: "/root/index.js"
        state: touch

    - name: install express
      command: chdir=/root/ npm install express

    - name: crete test.js file
      script: test.sh

    - name: start nodejs
      command: chdir=/root/ pm2 start test.js
